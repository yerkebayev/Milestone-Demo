<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IndexController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Milestone2</a> &gt; <a href="index.source.html" class="el_package">unist.ep.milestone2.controller</a> &gt; <span class="el_source">IndexController.java</span></div><h1>IndexController.java</h1><pre class="source lang-java linenums">package unist.ep.milestone2.controller;

import jakarta.servlet.http.HttpSession;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import unist.ep.milestone2.model.*;
import unist.ep.milestone2.repository.ClubRequest;
import unist.ep.milestone2.repository.ClubTypeResponse;
import unist.ep.milestone2.repository.HomeResponse;
import unist.ep.milestone2.repository.MainResponse;
import unist.ep.milestone2.service.*;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

@RestController
public class IndexController {
    private final UserService userService;
    private final ClubService clubService;
    private final TypeService typeService;
    private final RatingService ratingService;
    private final UserClubTypeService userClubTypeService;



<span class="fc" id="L28">    public IndexController(UserService userService, ClubService clubService, TypeService typeService, RatingService ratingService, UserClubTypeService userClubTypeService) {</span>
<span class="fc" id="L29">        this.userService = userService;</span>
<span class="fc" id="L30">        this.clubService = clubService;</span>
<span class="fc" id="L31">        this.typeService = typeService;</span>
<span class="fc" id="L32">        this.ratingService = ratingService;</span>
<span class="fc" id="L33">        this.userClubTypeService = userClubTypeService;</span>
<span class="fc" id="L34">    }</span>


    @PostMapping(&quot;/login&quot;)
    public ResponseEntity&lt;Long&gt; login(@RequestParam(value = &quot;email&quot;, defaultValue = &quot;&quot;) String email, @RequestParam(value = &quot;password&quot;, defaultValue = &quot;&quot;) String password, HttpSession session) {
<span class="fc" id="L39">        User user = userService.getUserByEmail(email);</span>
<span class="fc bfc" id="L40" title="All 2 branches covered.">        if (user == null) {</span>
<span class="fc" id="L41">            return new ResponseEntity&lt;&gt;(-1L, HttpStatus.UNAUTHORIZED);</span>
        }
<span class="pc bpc" id="L43" title="1 of 2 branches missed.">        if (user.getPassword().equals(password)) {</span>
<span class="fc" id="L44">            session.setAttribute(&quot;userId&quot;, user.getId());</span>
<span class="fc" id="L45">            return new ResponseEntity&lt;&gt;(user.getId(), HttpStatus.OK);</span>
        } else {
<span class="nc" id="L47">            return new ResponseEntity&lt;&gt;(-1L, HttpStatus.BAD_REQUEST);</span>
        }
    }
    @PostMapping(&quot;/admin/login&quot;)
    public ResponseEntity&lt;Long&gt; loginAdmin(@RequestParam(value = &quot;email&quot;, defaultValue = &quot;&quot;) String email, @RequestParam(value = &quot;password&quot;, defaultValue = &quot;&quot;) String password, HttpSession session) {
<span class="fc" id="L52">        User user = userService.getUserByEmail(email);</span>
<span class="pc bpc" id="L53" title="1 of 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L54">            return new ResponseEntity&lt;&gt;(-1L, HttpStatus.UNAUTHORIZED);</span>
        }
<span class="pc bpc" id="L56" title="1 of 4 branches missed.">        if (user.getPassword().equals(password) &amp;&amp; user.getRole() == 1) {</span>
<span class="fc" id="L57">            session.setAttribute(&quot;userId&quot;, user.getId());</span>
<span class="fc" id="L58">            return new ResponseEntity&lt;&gt;(user.getId(), HttpStatus.OK);</span>
        } else {
<span class="fc" id="L60">            return new ResponseEntity&lt;&gt;(-1L, HttpStatus.BAD_REQUEST);</span>
        }
    }
    @PostMapping(value = &quot;/register&quot;, produces = &quot;application/json&quot;)
    public ResponseEntity&lt;?&gt; addUser(@RequestParam(value = &quot;name&quot;, defaultValue = &quot;&quot;) String name, @RequestParam(value = &quot;surname&quot;, defaultValue = &quot;&quot;) String surname, @RequestParam(value = &quot;email&quot;, defaultValue = &quot;&quot;) String email,@RequestParam(value = &quot;password&quot;, defaultValue = &quot;&quot;) String password, HttpSession session) {
<span class="fc" id="L65">        System.out.println(name + &quot; &quot; + surname + &quot; &quot; + email + &quot; &quot; + password);</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">        if (email.endsWith(&quot;@unist.ac.kr&quot;)){</span>
<span class="fc" id="L67">            User u = userService.getUserByEmail(email);</span>
<span class="fc bfc" id="L68" title="All 2 branches covered.">            if (u == null) {</span>
<span class="fc" id="L69">                User newUser = userService.saveUser(new User(name, surname, email, password, 0));</span>
<span class="fc" id="L70">                newUser.setRole(0);</span>
<span class="fc" id="L71">                session.setAttribute(&quot;userId&quot;, newUser.getId());</span>
<span class="fc" id="L72">                return new ResponseEntity&lt;&gt;(newUser, HttpStatus.CREATED);</span>
            } else {
<span class="fc" id="L74">                return ResponseEntity.badRequest().body(&quot;There is already a user with this email&quot;);</span>
            }
        } else{
<span class="fc" id="L77">            return ResponseEntity.badRequest().body(&quot;You can only register using your Unist account&quot;);</span>
        }
    }

    @GetMapping(value = &quot;/clubs&quot;)
    public HomeResponse getClubs(HttpSession session) {
<span class="fc" id="L83">        Long user_id = (Long) session.getAttribute(&quot;userId&quot;);</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">        if (user_id == null) {</span>
<span class="fc" id="L85">            return new HomeResponse();</span>
        }
<span class="fc" id="L87">        Optional&lt;User&gt; userOptional = userService.getUserById(user_id);</span>
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">        if (userOptional.isEmpty()) {</span>
<span class="nc" id="L89">            return new HomeResponse();</span>
        }
<span class="fc" id="L91">        User user = userOptional.get();</span>
<span class="fc" id="L92">        List&lt;Club&gt; clubs = clubService.getAllClubs();</span>
<span class="fc" id="L93">        List&lt;ClubType&gt; clubTypes = userService.getPreferredClubTypes(user);</span>
<span class="fc" id="L94">        List&lt;Club&gt; recommendedClubs = clubService.getClubsByClubTypes(clubTypes);</span>
<span class="fc" id="L95">        return new HomeResponse(clubs, recommendedClubs);</span>
    }
    @GetMapping(value = &quot;/clubs/{id}&quot;, produces = &quot;application/json&quot;)
    public ResponseEntity&lt;MainResponse&gt; getClubPage(@PathVariable long id, HttpSession session) {
<span class="fc" id="L99">        Optional&lt;Club&gt; optionalClub = clubService.getClubById(id);</span>
<span class="fc" id="L100">        Long user_id = (Long) session.getAttribute(&quot;userId&quot;);</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">        if (user_id == null) {</span>
<span class="fc" id="L102">            return new ResponseEntity&lt;&gt;(new MainResponse(), HttpStatus.NOT_FOUND);</span>
        }
<span class="fc" id="L104">        Optional&lt;User&gt; userOptional = userService.getUserById(user_id);</span>
<span class="pc bpc" id="L105" title="1 of 4 branches missed.">        if (optionalClub.isEmpty() || userOptional.isEmpty()) {</span>
<span class="fc" id="L106">            return new ResponseEntity&lt;&gt;(new MainResponse(), HttpStatus.NOT_FOUND);</span>
        }
<span class="fc" id="L108">        Club club = optionalClub.get();</span>
<span class="fc" id="L109">        User user = userOptional.get();</span>

<span class="fc" id="L111">        List&lt;ClubType&gt; clubTypeList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L112">        Optional&lt;ClubType&gt; clubTypeOptional = typeService.getClubTypeById(club.getClubType_id());</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">        if (clubTypeOptional.isEmpty()) {</span>
<span class="nc" id="L114">            return new ResponseEntity&lt;&gt;(new MainResponse(), HttpStatus.NOT_FOUND);</span>
        }
<span class="fc" id="L116">        clubTypeList.add(clubTypeOptional.get());</span>

<span class="fc" id="L118">        List&lt;Club&gt; recommendedClubs = clubService.getClubsByClubTypes(clubTypeList);</span>
<span class="fc" id="L119">        List&lt;Rating&gt; ratings = ratingService.getRatingsByClubId(id);</span>
<span class="fc" id="L120">        Double averageRating = ratingService.getAverageRatingByClubId(id);</span>

<span class="fc" id="L122">        MainResponse mainResponse = new MainResponse(club, user, ratings, averageRating, recommendedClubs);</span>
<span class="fc" id="L123">        return new ResponseEntity&lt;&gt;(mainResponse, HttpStatus.OK);</span>
    }
    @GetMapping(value = &quot;/user/{id}&quot;)
    public User getUserById(@PathVariable long id) {
<span class="fc" id="L127">        Optional&lt;User&gt; userOptional = userService.getUserById(id);</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">        if (userOptional.isEmpty()) {</span>
<span class="fc" id="L129">            return null;</span>
        }
<span class="fc" id="L131">        return userOptional.get();</span>
    }
    @GetMapping(value = &quot;/ratings/{id}&quot;)
    public Rating getRatingById(@PathVariable long id) {
<span class="fc" id="L135">        Optional&lt;Rating&gt; ratingOptional = ratingService.getRatingById(id);</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">        if (ratingOptional.isEmpty()) {</span>
<span class="fc" id="L137">            return null;</span>
        }
<span class="fc" id="L139">        return ratingOptional.get();</span>
    }
    @GetMapping(value = &quot;/clubTypes&quot;)
    public ClubTypeResponse getAllClubTypes(HttpSession session) {
<span class="fc" id="L143">        Long user_id = (Long) session.getAttribute(&quot;userId&quot;);</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">        if (user_id == null) {</span>
<span class="fc" id="L145">            return new ClubTypeResponse(new ArrayList&lt;&gt;(), new ArrayList&lt;&gt;());</span>
        }
<span class="fc" id="L147">        Optional&lt;User&gt; optional = userService.getUserById(user_id);</span>
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        if (optional.isEmpty()) {</span>
<span class="nc" id="L149">            return null;</span>
        }
<span class="fc" id="L151">        User user = optional.get();</span>
<span class="fc" id="L152">        return new ClubTypeResponse(typeService.getAllClubTypes(), userService.getPreferredClubTypesInInteger(user));</span>
    }
    @GetMapping(value = &quot;/clubTypesForAdmin&quot;)
    public ClubTypeResponse getAllClubTypes() {
<span class="fc" id="L156">        return new ClubTypeResponse(typeService.getAllClubTypes(), null);</span>
    }

    @PostMapping(value = &quot;/clubTypes/add&quot;, consumes = &quot;application/x-www-form-urlencoded&quot;)
    public Long addClubTypes(@RequestParam(value = &quot;clubTypes&quot;, defaultValue = &quot;&quot;) String clubTypes, HttpSession session) {
<span class="fc" id="L161">        String[] clubTypesArray = clubTypes.split(&quot;_&quot;);</span>
<span class="fc" id="L162">        System.out.println(&quot;HERE&quot;);</span>
<span class="fc" id="L163">        Long user_id = (Long) session.getAttribute(&quot;userId&quot;);</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">        if (user_id == null) {</span>
<span class="fc" id="L165">            return -1L;</span>
        }
<span class="fc" id="L167">        Optional&lt;User&gt; optional = userService.getUserById(user_id);</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">        if (optional.isEmpty()) {</span>
<span class="nc" id="L169">            return -1L;</span>
        }
<span class="fc" id="L171">        User user = optional.get();</span>
<span class="fc" id="L172">        userClubTypeService.deleteUserClubType(user.getId());</span>
<span class="fc bfc" id="L173" title="All 2 branches covered.">        for (String clubType_id : clubTypesArray) {</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">            if (!clubType_id.equals(&quot; &quot;)) {</span>
<span class="fc" id="L175">                userClubTypeService.saveUserClubType(new UserClubType(user_id, Long.valueOf(clubType_id)));</span>
            }
        }
<span class="fc" id="L178">        return 1L;</span>
    }

    @PostMapping(value = &quot;/clubs/{id}/ratings&quot;, consumes = &quot;application/x-www-form-urlencoded&quot;, produces = &quot;application/json&quot;)
    public ResponseEntity&lt;Rating&gt; addRating(@PathVariable long id, @RequestParam(value = &quot;comment&quot;, defaultValue = &quot;&quot;) String comment, @RequestParam(value = &quot;rating&quot;, defaultValue = &quot;&quot;) Integer rating, HttpSession session) {
<span class="fc" id="L183">        Long user_id = (Long) session.getAttribute(&quot;userId&quot;);</span>
<span class="fc" id="L184">        System.out.println(&quot;Added&quot;);</span>

<span class="fc bfc" id="L186" title="All 2 branches covered.">        if (user_id == null) {</span>
<span class="fc" id="L187">            return new ResponseEntity&lt;&gt;(new Rating(), HttpStatus.NOT_FOUND);</span>
        }
<span class="fc" id="L189">        Optional&lt;User&gt; userOptional = userService.getUserById(user_id);</span>
<span class="fc" id="L190">        Optional&lt;Club&gt; optionalClub = clubService.getClubById(id);</span>
<span class="pc bpc" id="L191" title="1 of 4 branches missed.">        if (userOptional.isEmpty() || optionalClub.isEmpty()) {</span>
<span class="fc" id="L192">            return null;</span>
        }
<span class="fc" id="L194">        User user = userOptional.get();</span>
<span class="fc" id="L195">        Club club = optionalClub.get();</span>
<span class="fc" id="L196">        System.out.println(&quot;Added&quot;);</span>

<span class="fc" id="L198">        Rating newRating = new Rating(user.getId(), club.getId(), rating, comment);</span>
<span class="fc" id="L199">        ratingService.saveRating(newRating);</span>
<span class="fc" id="L200">        return new ResponseEntity&lt;&gt;(newRating, HttpStatus.CREATED);</span>
    }
    @GetMapping(value = &quot;/clubs/{id}/ratings/avg&quot;, produces = &quot;application/json&quot;)
    public ResponseEntity&lt;Double&gt; getAverageRatingOfClub(@PathVariable long id) {
<span class="fc" id="L204">        Optional&lt;Club&gt; optionalClub = clubService.getClubById(id);</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">        if (optionalClub.isEmpty()) {</span>
<span class="fc" id="L206">            return new ResponseEntity&lt;&gt;(null, HttpStatus.NOT_FOUND);</span>
        }
<span class="fc" id="L208">        Double averageRating = ratingService.getAverageRatingByClubId(id);</span>
<span class="fc" id="L209">        return new ResponseEntity&lt;&gt;(averageRating, HttpStatus.OK);</span>
    }
    @GetMapping(value = &quot;/admin/clubs&quot;)
    public ResponseEntity&lt;List&lt;Club&gt;&gt; getClubsForAdmin() {
<span class="fc" id="L213">        List&lt;Club&gt; clubs = clubService.getAllClubs();</span>
<span class="fc" id="L214">        return new ResponseEntity&lt;&gt;(clubs, HttpStatus.OK);</span>
    }
    @GetMapping(value = &quot;/admin/clubs/{id}&quot;, produces = &quot;application/json&quot;)
    public ResponseEntity&lt;ClubRequest&gt; getClubPageForAdmin(@PathVariable long id) {
<span class="fc" id="L218">        Optional&lt;Club&gt; optionalClub = clubService.getClubById(id);</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">        if (optionalClub.isEmpty()) {</span>
<span class="fc" id="L220">            return new ResponseEntity&lt;&gt;(null, HttpStatus.NOT_FOUND);</span>
        }
<span class="fc" id="L222">        Club club = optionalClub.get();</span>
<span class="fc" id="L223">        User head = userService.getUserById(club.getHead_id()).get();</span>
<span class="fc" id="L224">        return new ResponseEntity&lt;&gt;(new ClubRequest(club.getId(), club.getName(), club.getClubType_id(), club.getEmail(), club.getMission(), club.getDescription(), head.getName() + &quot; &quot; + head.getSurname(), club.getContact(), club.getImage()), HttpStatus.OK);</span>
    }
    @PostMapping(value = &quot;/admin/clubs&quot;, produces = &quot;application/json&quot;)
    public ResponseEntity&lt;Club&gt; addClub(@RequestParam(value = &quot;name&quot;, defaultValue = &quot;&quot;) String name,
                                        @RequestParam(value = &quot;clubType&quot;, defaultValue = &quot;&quot;) Long clubType,
                                        @RequestParam(value = &quot;headEmail&quot;, defaultValue = &quot;&quot;) String headEmail,
                                        @RequestParam(value = &quot;email&quot;, defaultValue = &quot;&quot;) String email,
                                        @RequestParam(value = &quot;description&quot;, defaultValue = &quot;&quot;) String description,
                                        @RequestParam(value = &quot;mission&quot;, defaultValue = &quot;&quot;) String mission,
                                        @RequestParam(value = &quot;contact&quot;, defaultValue = &quot;&quot;) String contact,
                                        @RequestParam(value = &quot;image&quot;, defaultValue = &quot;&quot;) String image) {
<span class="fc" id="L235">        System.out.println(name + &quot; &quot; + clubType + &quot; &quot; + headEmail + &quot; &quot; + email);</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">        if (clubType == null) {</span>
<span class="fc" id="L237">            clubType = 1L;</span>
        }
<span class="fc" id="L239">        User head = userService.getUserByEmail(headEmail);</span>
<span class="fc" id="L240">        Club cl = clubService.getClubByEmail(email);</span>
<span class="pc bpc" id="L241" title="2 of 4 branches missed.">        if (head != null &amp;&amp; cl == null) {</span>
<span class="fc" id="L242">            Club newClub = clubService.saveClub(new Club(name, email, clubType, description, mission, contact, head.getId(), image));</span>
<span class="fc" id="L243">            return new ResponseEntity&lt;&gt;(newClub, HttpStatus.CREATED);</span>
        }
<span class="nc" id="L245">        String[] headNameAndSurname = (headEmail.split(&quot; &quot;));</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (headNameAndSurname.length &gt; 1) {</span>
<span class="nc" id="L247">            User newHead = userService.getUserByNameAndSurname(headNameAndSurname[0], headNameAndSurname[1]);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">            if (newHead != null) {</span>
<span class="nc" id="L249">                System.out.println(newHead.getId() + &quot; &quot; + newHead.getName());</span>
<span class="nc" id="L250">                System.out.println(&quot;MY ID &quot; + cl.getId());</span>
<span class="nc" id="L251">                cl.setName(name);</span>
<span class="nc" id="L252">                cl.setClubType_id(clubType);</span>
<span class="nc" id="L253">                cl.setEmail(email);</span>
<span class="nc" id="L254">                cl.setDescription(description);</span>
<span class="nc" id="L255">                cl.setMission(mission);</span>
<span class="nc" id="L256">                cl.setHead_id(newHead.getId());</span>
<span class="nc" id="L257">                cl.setContact(contact);</span>
<span class="nc" id="L258">                cl.setImage(image);</span>
<span class="nc" id="L259">                clubService.saveClub(cl);</span>
<span class="nc" id="L260">                return new ResponseEntity&lt;&gt;(cl, HttpStatus.OK);</span>
            }
<span class="nc" id="L262">            return new ResponseEntity&lt;&gt;(null, HttpStatus.BAD_REQUEST);</span>
        }
<span class="nc" id="L264">        return new ResponseEntity&lt;&gt;(null, HttpStatus.BAD_REQUEST);</span>
    }

    @DeleteMapping(value = &quot;/admin/clubs/{id}&quot;, produces = &quot;application/json&quot;)
    public ResponseEntity&lt;Long&gt; deleteClub(@PathVariable long id) {
<span class="fc bfc" id="L269" title="All 2 branches covered.">        if (clubService.deleteClubById(id) &gt; 0) {</span>
<span class="fc" id="L270">            return new ResponseEntity&lt;&gt;(1L, HttpStatus.OK);</span>
        } else {
<span class="fc" id="L272">            return new ResponseEntity&lt;&gt;(-1L, HttpStatus.NOT_FOUND);</span>
        }
    }
    public static class RatingData{
        private Integer rating;
        private String comment;

        public Integer getRating() {
<span class="nc" id="L280">            return rating;</span>
        }

        public void setRating(Integer rating) {
<span class="nc" id="L284">            this.rating = rating;</span>
<span class="nc" id="L285">        }</span>

        public String getComment() {
<span class="nc" id="L288">            return comment;</span>
        }

        public void setComment(String comment) {
<span class="nc" id="L292">            this.comment = comment;</span>
<span class="nc" id="L293">        }</span>

<span class="nc" id="L295">        public RatingData() {</span>
<span class="nc" id="L296">        }</span>

<span class="nc" id="L298">        public RatingData(Integer rating, String comment) {</span>
<span class="nc" id="L299">            this.rating = rating;</span>
<span class="nc" id="L300">            this.comment = comment;</span>
<span class="nc" id="L301">        }</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>